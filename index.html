<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safe The Uyghurs</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0; overflow: hidden; background-color: #111;
            font-family: 'Press Start 2P', cursive;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        canvas {
            display: block; margin: 0 auto; background-color: #dcb159;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; z-index: 5;
        }

        #top-ui {
            padding: 10px; display: flex; flex-direction: column; gap: 5px;
            color: #fff; text-shadow: 2px 2px 0 #000; font-size: 10px;
            background: rgba(0,0,0,0.3);
        }

        .stat-line { display: flex; justify-content: space-between; width: 100%; }

        /* SCREENS */
        #start-screen, #game-over-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18, 24, 33, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 10; pointer-events: auto; text-align: center;
        }

        h1 { font-size: 24px; color: #ffcc00; margin-bottom: 5px; text-shadow: 4px 4px 0 #8b0000; line-height: 1.5; }
        
        .mode-container { display: flex; flex-direction: column; gap: 20px; margin-top: 25px; width: 80%; max-width: 300px; align-items: center; }
        .mode-card {
            border: 2px solid #555; background: #222; padding: 10px; width: 100%;
            cursor: pointer; transition: all 0.1s; display: flex; flex-direction: row; align-items: center; gap: 15px;
            border-radius: 8px; text-align: left;
        }
        .mode-card:active { border-color: #ffcc00; background: #333; transform: scale(0.98); }
        .mode-info { display: flex; flex-direction: column; }
        .mode-title { font-size: 12px; color: #ffcc00; margin-bottom: 5px; }
        .mode-desc { font-size: 8px; color: #aaa; line-height: 1.4; }

        .btn { background: #d32f2f; border: 4px solid #fff; padding: 15px 30px; color: white; font-family: 'Press Start 2P'; font-size: 16px; cursor: pointer; margin-top: 20px; }

        /* GAME OVER STATS */
        #go-text { font-size: 10px; line-height: 1.6; max-width: 80%; color: #ccc; margin-bottom: 20px; border-top: 1px solid #555; border-bottom: 1px solid #555; padding: 10px 0; }
        .stat-box { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; width: 80%; }
        .stat-row { display: flex; justify-content: space-between; font-size: 12px; color: #fff; border-bottom: 1px dashed #444; padding-bottom: 5px;}

        /* CONTROLS */
        .controls-hint { display: flex; width: 100%; height: 200px; pointer-events: none; position: absolute; bottom: 0; }
        .left-control { width: 50%; pointer-events: auto; }
        .right-control { width: 50%; pointer-events: auto; position: relative; }
        .game-btn {
            border-radius: 50%; border: 3px solid rgba(255,255,255,0.9); 
            background: rgba(0,0,0,0.4); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; position: absolute; touch-action: manipulation;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .game-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        #btn-flash { width: 85px; height: 85px; right: 40px; bottom: 50px; background: rgba(255, 255, 255, 0.1); }
        #btn-kick { width: 75px; height: 75px; right: 20px; bottom: 100px; background: rgba(200, 50, 50, 0.3); font-size: 20px;}
        #btn-grab { width: 75px; height: 75px; right: 100px; bottom: 30px; background: rgba(50, 50, 200, 0.3); font-size: 20px;}
        .hidden { display: none !important; }
        #joystick-ui {
            position: absolute; width: 100px; height: 100px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: none; pointer-events: none;
        }
        #joystick-stick {
            position: absolute; width: 40px; height: 40px;
            background: rgba(255,255,255,0.5); border-radius: 50%; top: 30px; left: 30px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="top-ui">
            </div>
        <div id="joystick-ui"><div id="joystick-stick"></div></div>
        <div class="controls-hint">
            <div class="left-control" id="joystick-zone"></div>
            <div class="right-control">
                <div id="btn-flash" class="game-btn hidden" ontouchstart="doAction('flash', event)">üì∏</div>
                <div id="btn-kick" class="game-btn hidden" ontouchstart="doAction('kick', event)">üèè</div>
                <div id="btn-grab" class="game-btn hidden" ontouchstart="doAction('grab', event)">‚úã</div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>SAFE THE<br>UYGHURS</h1>
        <p style="font-size: 10px; color: #aaa; margin-bottom: 20px;">SELECT MODE</p>
        <div class="mode-container">
            <div class="mode-card" onclick="setMode('whistleblower')">
                <canvas id="p1-canvas" width="60" height="60"></canvas>
                <div class="mode-info">
                    <div class="mode-title">WHISTLEBLOWER</div>
                    <div class="mode-desc">Expose the truth.<br>Save them.</div>
                </div>
            </div>
            <div class="mode-card" onclick="setMode('perpetrator')">
                <canvas id="p2-canvas" width="60" height="60"></canvas>
                <div class="mode-info">
                    <div class="mode-title">PERPETRATOR</div>
                    <div class="mode-desc">Enforce order.<br>Stop intruders.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-over-screen" style="display: none;">
        <h1 id="go-title" style="color: #ff5555">GAME OVER</h1>
        <div class="stat-box" id="stat-container"></div>
        <p id="go-text">...</p>
        <button class="btn" onclick="showStartScreen()">MAIN MENU</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    // --- ASSETS ---
    const C = {
        sand: '#e0cda6', sandDetail: '#d0bd96',
        wall: '#3a3f4b', wallDark: '#20232a', door: '#1a1a1a', wire: '#111',
        skin: '#f5cba7', wbBlue: '#3498db',
        swatBlack: '#1e272e', swatRed: '#c0392b',
        flashColor: 'rgba(255, 255, 255, 0.85)'
    };
    const WIRE_Y = 180; // Hard border

    // --- STATE ---
    let GAME_MODE = 'whistleblower';
    let gameActive = false;
    let frame = 0;
    let score = 0;
    let cooldown = 0;
    
    // Stats
    let stats = { escaped: 0, detained: 0, silenced: 0, exposed: 0, lost: 0 };

    let hero = { x: 0, y: 0, speed: 4, hp: 100, angle: -Math.PI/2, facing: 1, state: 'idle', holding: null };
    let entities = [];
    let items = [];
    let particles = [];
    let smokeParticles = [];
    let floatTexts = [];
    let joystick = { on: false, id: null, sx: 0, sy: 0, cx: 0, cy: 0 };

    // --- PORTRAITS ---
    function drawPixelFace(ctx, type) {
        ctx.clearRect(0,0,60,60);
        let map = type==='wb' 
            ? [0,0,2,2,2,2,2,0, 0,2,2,2,2,2,2,2, 0,2,2,1,1,1,2,2, 0,2,1,1,1,1,1,2, 0,2,1,2,1,2,1,2, 0,2,1,1,1,1,1,2, 0,2,1,1,1,1,1,2, 0,0,3,3,3,3,3,0]
            : [0,2,2,2,2,2,2,0, 0,2,2,2,2,2,2,0, 0,2,2,4,4,4,2,0, 0,2,2,4,4,4,2,0, 0,2,2,2,2,2,2,0, 0,0,2,2,2,2,0,0, 0,0,2,2,2,2,0,0, 0,0,2,2,2,2,0,0];
        ctx.save(); ctx.translate(10, 10);
        for(let r=0; r<8; r++) {
            for(let c=0; c<8; c++) {
                let v = map[r*8+c];
                if(v) {
                    ctx.fillStyle = v===1?C.skin : v===2?'#111' : v===3?C.wbBlue : '#f00';
                    ctx.fillRect(c*5, r*5, 5, 5);
                }
            }
        }
        ctx.restore();
    }
    setTimeout(() => {
        drawPixelFace(document.getElementById('p1-canvas').getContext('2d'), 'wb');
        drawPixelFace(document.getElementById('p2-canvas').getContext('2d'), 'swat');
    }, 100);

    // --- CONTROLS ---
    const joyZone = document.getElementById('joystick-zone');
    const joyUI = document.getElementById('joystick-ui');
    const joyStick = document.getElementById('joystick-stick');

    joyZone.addEventListener('touchstart', e => {
        e.preventDefault(); let t = e.changedTouches[0];
        joystick.on = true; joystick.id = t.identifier;
        joystick.sx = t.clientX; joystick.sy = t.clientY; joystick.cx = t.clientX; joystick.cy = t.clientY;
        joyUI.style.display = 'block'; joyUI.style.left = (t.clientX-50)+'px'; joyUI.style.top = (t.clientY-50)+'px'; joyStick.style.left = '30px'; joyStick.style.top = '30px';
    }, {passive:false});
    joyZone.addEventListener('touchmove', e => {
        e.preventDefault(); for(let t of e.changedTouches) if(joystick.on && t.identifier===joystick.id) {
            joystick.cx = t.clientX; joystick.cy = t.clientY;
            let dx = t.clientX-joystick.sx, dy = t.clientY-joystick.sy, dist = Math.min(Math.hypot(dx,dy), 30), ang = Math.atan2(dy,dx);
            joyStick.style.left = (30+Math.cos(ang)*dist)+'px'; joyStick.style.top = (30+Math.sin(ang)*dist)+'px';
        }
    }, {passive:false});
    joyZone.addEventListener('touchend', e => {
        e.preventDefault(); for(let t of e.changedTouches) if(joystick.on && t.identifier===joystick.id) { joystick.on = false; joyUI.style.display = 'none'; }
    }, {passive:false});

    // --- LOGIC ---
    function setMode(mode) {
        GAME_MODE = mode;
        ['btn-flash','btn-kick','btn-grab'].forEach(id => document.getElementById(id).classList.add('hidden'));
        if(mode === 'whistleblower') document.getElementById('btn-flash').classList.remove('hidden');
        else {
            document.getElementById('btn-kick').classList.remove('hidden');
            document.getElementById('btn-grab').classList.remove('hidden');
        }
        startGame();
    }

    function showStartScreen() {
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('game-over-screen').style.display = 'none';
        gameActive = false;
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'none';
        
        hero.x = canvas.width/2; hero.y = canvas.height-150; hero.hp = 100;
        hero.angle = -Math.PI/2; hero.holding = null;
        
        entities = []; items = []; particles = []; smokeParticles = []; floatTexts = [];
        score = 0; frame = 0; gameActive = true;
        stats = { escaped: 0, detained: 0, silenced: 0, exposed: 0, lost: 0 };

        if(GAME_MODE === 'perpetrator') {
            spawnEntity('swat_ally'); spawnEntity('swat_ally');
        }

        loop();
    }

    function updateStatsUI() {
        const ui = document.getElementById('top-ui');
        if(GAME_MODE === 'whistleblower') {
            ui.innerHTML = `
                <div class="stat-line"><span style="color:#0f0">ESCAPED: ${stats.escaped}</span> <span style="color:#fff">EXPOSED: ${stats.exposed}</span></div>
            `;
        } else {
            ui.innerHTML = `
                <div class="stat-line"><span style="color:#f00">SILENCED: ${stats.silenced}</span> <span style="color:#aaa">DETAINED: ${stats.detained}</span></div>
                <div class="stat-line"><span style="color:#0f0">ESCAPED: ${stats.escaped}</span></div>
            `;
        }
    }

    function loop() {
        if(!gameActive) return;
        update(); draw(); updateStatsUI(); frame++;
        requestAnimationFrame(loop);
    }

    function update() {
        if(cooldown > 0) cooldown--;
        if(hero.flashTimer > 0) hero.flashTimer--;
        if(hero.swingTimer > 0) hero.swingTimer--;

        // Movement
        if(joystick.on) {
            let dx = joystick.cx - joystick.sx, dy = joystick.cy - joystick.sy;
            if(Math.hypot(dx,dy) > 10) {
                hero.angle = Math.atan2(dy, dx);
                let spd = hero.holding ? hero.speed * 0.5 : hero.speed;
                hero.x += Math.cos(hero.angle) * spd; hero.y += Math.sin(hero.angle) * spd;
                hero.state = 'run';
                hero.facing = Math.abs(hero.angle) > Math.PI/2 ? -1 : 1;
            } else hero.state = 'idle';
        } else hero.state = 'idle';

        // Boundaries
        hero.x = Math.max(20, Math.min(canvas.width-20, hero.x));
        hero.y = Math.min(canvas.height-20, hero.y);
        
        if(GAME_MODE === 'whistleblower') {
            if(hero.y < WIRE_Y) hero.y = WIRE_Y;
        } else {
            // Perp can pass if holding someone near center
            if(hero.holding && Math.abs(hero.x - canvas.width/2) < 60) {
                if(hero.y < 120) {
                    let type = hero.holding.type; // Check if Civ or WB
                    spawnFloatText(hero.x, hero.y, "DETAINED", "#fff");
                    score++; 
                    if(type === 'civ') stats.detained++;
                    else if(type === 'wb') stats.silenced++;
                    
                    hero.holding.dead = true; hero.holding = null; hero.y = WIRE_Y+10;
                }
            } else {
                if(hero.y < WIRE_Y) hero.y = WIRE_Y;
            }
        }

        // --- SMOKE ---
        if(frame % 5 === 0) {
            [canvas.width/2 - 80, canvas.width/2 + 80, canvas.width/2 + 140].forEach(x => {
                smokeParticles.push({
                    x: x + (Math.random()-0.5)*10, y: 10,
                    vx: (Math.random()-0.5), vy: -1 - Math.random(),
                    life: 100, size: 2+Math.random()*3
                });
            });
        }

        // Spawn Logic
        if(frame % 110 === 0) spawnEntity('civ');
        let rate = GAME_MODE === 'whistleblower' ? Math.max(30, 150 - (score * 4)) : Math.max(50, 250 - (score * 2));
        if(frame % Math.floor(rate) === 0) {
            if(GAME_MODE === 'whistleblower') spawnEntity('swat_enemy');
            else spawnEntity('wb_enemy');
        }
        if(frame % 500 === 0) spawnItem();

        // Entities Update
        entities.forEach(e => {
            if(e.dead) return;

            // CIVILIAN
            if(e.type === 'civ') {
                if(e.state === 'run') {
                    e.y += e.speed; e.x += Math.sin(frame*0.05 + e.id)*0.5;
                    if(e.y < WIRE_Y) e.y = WIRE_Y;
                    if(e.y > canvas.height + 20) {
                        e.dead = true;
                        if(GAME_MODE === 'whistleblower') { score++; stats.escaped++; spawnFloatText(e.x, canvas.height-20, "+1", "#0f0"); }
                        else { stats.escaped++; }
                    }
                }
            }

            // ENEMY SWAT (WB Mode - AI)
            if(e.type === 'swat' && e.team === 'enemy') {
                let target = null;
                let action = 'idle';

                // LOGIC: Check both Hero and Nearest Civ. Divide attention evenly or based on distance.
                let distToHero = dist(e, hero);
                // Find closest civilian
                let nearestCiv = entities.find(c => c.type === 'civ' && !c.dead && !c.beingDragged && c.y > WIRE_Y);
                let distToCiv = nearestCiv ? dist(e, nearestCiv) : 9999;

                // Decision: If Hero is very close or attacking, target Hero. Else target nearest entity.
                if (hero.hp > 0 && (distToHero < 150 || hero.flashTimer > 0)) {
                    // Bias towards hero if close
                    if (!nearestCiv || distToHero < distToCiv) {
                        target = hero;
                        action = 'attack';
                    } else {
                        target = nearestCiv;
                        action = 'capture';
                    }
                } else if (nearestCiv) {
                    target = nearestCiv;
                    action = 'capture';
                }

                if(target) {
                    let ang = Math.atan2(target.y - e.y, target.x - e.x);
                    e.angle = ang; e.facing = Math.abs(ang) > Math.PI/2 ? -1 : 1;
                    let range = action === 'capture' ? 20 : 35;
                    
                    if(dist(e, target) > range) {
                        e.x += Math.cos(ang) * e.speed; e.y += Math.sin(ang) * e.speed; e.state = 'run';
                    } else {
                        e.state = 'idle';
                        if(frame % 30 === 0) {
                            if(action === 'attack') damageHero(10);
                            if(action === 'capture') {
                                if(target.state !== 'stunned') { target.state = 'stunned'; spawnBlood(target.x, target.y); }
                                else { e.holding = target; target.beingDragged = true; e.state = 'drag'; }
                            }
                        }
                    }
                }
                
                // Dragging Logic
                if(e.holding) {
                    let doorAng = Math.atan2(80 - e.y, canvas.width/2 - e.x);
                    e.x += Math.cos(doorAng) * (e.speed * 0.8); e.y += Math.sin(doorAng) * (e.speed * 0.8);
                    e.holding.x = e.x; e.holding.y = e.y;
                    if(e.y < 120) {
                        e.holding.dead = true; e.holding = null; 
                        stats.lost++; spawnFloatText(e.x, e.y, "TAKEN", "#f00");
                    }
                } else if(e.y < WIRE_Y) e.y = WIRE_Y;
            }

            // ALLY SWAT (Perp Mode)
            if(e.type === 'swat' && e.team === 'ally') {
                if(e.holding) {
                    let ang = Math.atan2(80 - e.y, (canvas.width/2) - e.x);
                    e.x += Math.cos(ang) * (e.speed * 0.8); e.y += Math.sin(ang) * (e.speed * 0.8);
                    e.holding.x = e.x - (e.facing*10); e.holding.y = e.y;
                    if(e.y < 120) {
                        score++; stats.detained++;
                        e.holding.dead = true; e.holding = null;
                        spawnFloatText(e.x, e.y, "+1 ALLY", "#aaa");
                    }
                } else {
                    let target = entities.find(c => c.type === 'civ' && c.state === 'stunned' && !c.beingDragged && c.y > WIRE_Y);
                    if(target) {
                        let ang = Math.atan2(target.y - e.y, target.x - e.x);
                        e.angle = ang; e.facing = Math.abs(ang) > Math.PI/2 ? -1 : 1;
                        if(dist(e, target) > 20) {
                            e.x += Math.cos(ang) * e.speed; e.y += Math.sin(ang) * e.speed; e.state = 'run';
                        } else { e.holding = target; target.beingDragged = true; }
                    } else {
                        let ang = Math.atan2((hero.y-50) - e.y, hero.x - e.x);
                        if(dist(e, hero) > 80) { e.x += Math.cos(ang) * e.speed; e.y += Math.sin(ang) * e.speed; e.state = 'run'; }
                        else e.state = 'idle';
                    }
                }
            }

            // ENEMY WB (Perp Mode - Spawn Bottom)
            if(e.type === 'wb') {
                // Prevent exiting screen at top
                if(e.y < WIRE_Y + 50) e.y = WIRE_Y + 50; 

                let d = dist(e, hero);
                let ang = Math.atan2(hero.y - e.y, hero.x - e.x);
                e.angle = ang; e.facing = Math.abs(ang) > Math.PI/2 ? -1 : 1;
                
                // Aggressive/Evasive logic
                if(d > 200) { e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed; e.state='run'; }
                else if(d < 100) { e.x -= Math.cos(ang)*e.speed; e.y -= Math.sin(ang)*e.speed; e.state='run'; }
                else {
                    e.state = 'idle';
                    if(frame % 60 === 0 && Math.random()<0.7) { 
                        e.flashTimer = 15;
                        if(Math.abs(normalizeAngle(ang - Math.atan2(hero.y-e.y, hero.x-e.x))) < 0.6) damageHero(8);
                    }
                }
                
                // Keep inside
                if(e.x < 10) e.x = 10; if(e.x > canvas.width-10) e.x = canvas.width-10;
                if(e.y > canvas.height) e.y = canvas.height;
                if(e.flashTimer>0) e.flashTimer--;
            }
        });

        if(hero.holding) {
            hero.holding.x = hero.x - (hero.facing*15); hero.holding.y = hero.y;
            hero.holding.state = 'captured'; hero.holding.facing = hero.facing;
            hero.holding.beingDragged = true;
        }

        // Cleanup & Item Collision Fix
        entities = entities.filter(e => !e.dead);
        items.forEach(i => {
            if(!i.dead && dist(hero, i) < 40) { // Increased pickup range
                if((GAME_MODE==='whistleblower' && i.type==='film') || (GAME_MODE==='perpetrator' && i.type==='coin')) {
                    i.dead = true;
                    hero.hp = Math.min(100, hero.hp + 25);
                    spawnFloatText(hero.x, hero.y, "+HP", "#0f0");
                }
            }
        });
        items = items.filter(i => !i.dead);
        
        particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life--; }); particles = particles.filter(p => p.life > 0);
        smokeParticles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life--; p.size+=0.1; }); smokeParticles = smokeParticles.filter(p => p.life > 0);
        floatTexts.forEach(t => { t.y-=0.5; t.life--; }); floatTexts = floatTexts.filter(t => t.life > 0);
    }

    // --- ACTIONS ---
    function doAction(a, e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }
        if(!gameActive) return;

        if(a==='flash' && cooldown<=0) {
            cooldown = 25; hero.flashTimer = 8;
            entities.forEach(t => {
                let diff = normalizeAngle(Math.atan2(t.y-hero.y, t.x-hero.x) - hero.angle);
                // REDUCED CONE: dist 100, angle 0.4
                if(dist(hero,t)<100 && Math.abs(diff)<0.4) {
                    if(t.type==='civ' && t.state==='stunned') {
                        t.state = 'run'; t.beingDragged = false; spawnFloatText(t.x, t.y, "FREED!", "#0f0");
                    }
                    if(t.type==='swat' && t.team==='enemy') {
                        t.dead = true; if(t.holding){t.holding.beingDragged=false; t.holding.state='run';}
                        spawnExplosion(t.x, t.y); score++; stats.exposed++; spawnFloatText(t.x, t.y, "EXPOSED", "#fff");
                    }
                }
            });
        }
        else if(a==='kick' && cooldown<=0) {
            cooldown = 20; hero.swingTimer = 10;
            entities.forEach(t => {
                if(dist(hero,t)<60 && !t.dead) {
                    // Kick WB or Civ
                    if(t.type==='wb' || t.type==='civ') {
                        spawnBlood(t.x, t.y);
                        t.hits = (t.hits || 0) + 1;
                        // 3 hits to kill
                        if(t.hits >= 3) {
                            t.dead = true; spawnExplosion(t.x, t.y);
                            if(t.type==='wb') { score++; stats.silenced++; spawnFloatText(t.x, t.y, "SILENCED", "#f00"); }
                        } else {
                            t.state = 'stunned'; spawnFloatText(t.x, t.y, "STUNNED", "#ff0");
                        }
                    }
                }
            });
        }
        else if(a==='grab') {
            if(hero.holding) { hero.holding.state='run'; hero.holding.beingDragged=false; hero.holding=null; }
            else {
                // Can grab civ OR stunned WB
                let t = entities.find(e => (e.type==='civ' || (e.type==='wb' && e.state==='stunned')) && dist(hero,e)<50 && e.y>=WIRE_Y && !e.beingDragged);
                if(t) { hero.holding = t; spawnFloatText(hero.x, hero.y, "GRAB", "#fff"); }
            }
        }
    }

    // --- HELPERS ---
    function spawnEntity(type) {
        let x = canvas.width/2 + (Math.random()*240-120);
        let ySpawn = WIRE_Y + 10;
        if(type === 'wb_enemy') ySpawn = canvas.height + 10; // Spawn bottom for WBs

        let e = { id:Math.random(), x:x, y:ySpawn, dead:false, anim:Math.random()*10, angle:Math.PI/2, facing:1, type:type, team:'neutral' };
        
        if(type==='civ') { e.color=`hsl(${Math.random()*360},60%,50%)`; e.speed=1+Math.random(); e.state='run'; }
        else if(type==='swat_enemy') { e.type='swat'; e.team='enemy'; e.ai=true; e.speed=2.5 + (score/100); e.state='run'; }
        else if(type==='swat_ally') { e.type='swat'; e.team='ally'; e.ai=true; e.speed=2.5; e.state='idle'; }
        else if(type==='wb_enemy') { e.type='wb'; e.ai=true; e.speed=4.0; e.state='run'; e.flashTimer=0; e.hp=1; } // Speed 4 for WB
        entities.push(e);
    }
    
    function spawnItem() {
        let t = GAME_MODE==='whistleblower'?'film':'coin';
        // Fix spawn area: Between Wire + 30 and Bottom - 30
        let minY = WIRE_Y + 30;
        let maxY = canvas.height - 30;
        let spawnY = minY + Math.random() * (maxY - minY);
        items.push({ type:t, x:30+Math.random()*(canvas.width-60), y:spawnY, life:600, dead:false });
    }

    function spawnFloatText(x,y,t,c) { floatTexts.push({x,y,txt:t,col:c,life:60}); }
    function spawnExplosion(x,y) { for(let i=0;i<12;i++) particles.push({x,y,vx:(Math.random()-.5)*10, vy:(Math.random()-.5)*10, color:'#000', life:20, size:4}); }
    function spawnBlood(x,y) { for(let i=0;i<8;i++) particles.push({x,y,vx:(Math.random()-.5)*6, vy:(Math.random()-.5)*6, color:'#b00', life:30, size:3}); }
    function damageHero(a) {
        hero.hp -= a; spawnBlood(hero.x, hero.y); spawnFloatText(hero.x, hero.y, "-HP", "#f00");
        if(hero.hp<=0) gameOver();
    }
    function gameOver() {
        gameActive = false;
        document.getElementById('game-over-screen').style.display = 'flex';
        document.getElementById('go-title').innerText = GAME_MODE === 'whistleblower' ? "MISSION ENDED" : "WORK COMPLETE";
        
        let container = document.getElementById('stat-container');
        container.innerHTML = '';
        
        if(GAME_MODE === 'perpetrator') {
            container.innerHTML += `<div class="stat-row"><span>Silenced WBs:</span><span>${stats.silenced}</span></div>`;
            container.innerHTML += `<div class="stat-row"><span>Uyghurs Escaped:</span><span>${stats.escaped}</span></div>`;
            container.innerHTML += `<div class="stat-row"><span>Uyghurs Detained:</span><span>${stats.detained}</span></div>`;
            document.getElementById('go-text').innerText = `Congratulations, you are now a direct perpetrator of the Uyghur genocide. You successfully detained ${stats.detained} Uyghurs. The Party thanks you. You can now continue your comfortable life and enjoy cheap products made through forced labor.`;
        } else {
            container.innerHTML += `<div class="stat-row"><span>People Escaped:</span><span>${stats.escaped}</span></div>`;
            container.innerHTML += `<div class="stat-row"><span>Perpetrators Exposed:</span><span>${stats.exposed}</span></div>`;
            container.innerHTML += `<div class="stat-row"><span>People Lost:</span><span>${stats.lost}</span></div>`;
            document.getElementById('go-text').innerText = `Dear Whistleblower, thank you very much for exposing the Uyghur genocide to the world. Your footage has saved ${stats.escaped} lives.`;
        }
    }
    function dist(a,b) { return Math.hypot(a.x-b.x, a.y-b.y); }
    function normalizeAngle(a) { while(a>Math.PI)a-=Math.PI*2; while(a<-Math.PI)a+=Math.PI*2; return a; }

    // --- DRAWING ---
    function draw() {
        ctx.fillStyle = C.sand; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = C.sandDetail;
        for(let i=0; i<canvas.width; i+=40) for(let j=WIRE_Y; j<canvas.height; j+=40) if((i+j)%3==0) ctx.fillRect(i, j, 4, 4);
        
        // CAMP
        ctx.fillStyle = C.wall; ctx.fillRect(0,0,canvas.width, WIRE_Y);
        ctx.fillStyle = '#222';
        ctx.fillRect(canvas.width/2 - 90, 0, 20, WIRE_Y); ctx.fillRect(canvas.width/2 + 70, 0, 20, WIRE_Y); ctx.fillRect(canvas.width/2 + 130, 0, 20, WIRE_Y);
        ctx.fillStyle = C.door; ctx.fillRect(canvas.width/2-40, WIRE_Y-70, 80, 70);
        
        smokeParticles.forEach(p => { ctx.fillStyle = `rgba(30,30,30,${p.life/100})`; ctx.fillRect(p.x, p.y, p.size, p.size); });

        ctx.strokeStyle = C.wire; ctx.lineWidth = 2; ctx.beginPath();
        ctx.moveTo(0, WIRE_Y-5); ctx.lineTo(canvas.width, WIRE_Y-5);
        for(let i=0; i<canvas.width; i+=20) { ctx.moveTo(i, WIRE_Y-10); ctx.lineTo(i+10, WIRE_Y); ctx.moveTo(i+10, WIRE_Y-10); ctx.lineTo(i, WIRE_Y); }
        ctx.stroke();

        items.forEach(i => {
            ctx.save(); ctx.translate(i.x, i.y);
            if(i.type==='film') { 
                // Film Strip Graphic
                ctx.fillStyle='#000'; ctx.fillRect(-8,-12,16,24); 
                ctx.fillStyle='#fff'; 
                // sprocket holes
                for(let k=-10; k<10; k+=4) { ctx.fillRect(-7, k, 2, 2); ctx.fillRect(5, k, 2, 2); }
                ctx.fillStyle='#555'; ctx.fillRect(-3, -12, 6, 24); // center
            }
            else { ctx.fillStyle='#f1c40f'; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.font='10px Arial'; ctx.fillText('$',-3,4); }
            ctx.restore();
        });

        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        entities.forEach(e => { ctx.beginPath(); ctx.ellipse(e.x, e.y, 10, 4, 0, 0, Math.PI*2); ctx.fill(); });
        ctx.beginPath(); ctx.ellipse(hero.x, hero.y, 12, 5, 0, 0, Math.PI*2); ctx.fill();

        entities.forEach(e => {
            draw2DChar(ctx, { type:e.type==='civ'?'civ':(e.type==='swat'?'hero_swat':'hero_wb'), state:e.state, facing:e.facing||1, anim:frame+e.id*10, color:e.color }, e.x, e.y);
            if(e.type==='wb' && e.flashTimer>0) drawFlash(ctx, e.x, e.y, e.angle);
        });

        let hType = GAME_MODE==='whistleblower'?'hero_wb':'hero_swat';
        draw2DChar(ctx, { type:hType, state:hero.state, facing:hero.facing, anim:frame, hp:hero.hp }, hero.x, hero.y);
        if(hero.flashTimer > 0) drawFlash(ctx, hero.x, hero.y, hero.angle);

        particles.forEach(p => { ctx.fillStyle=p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
        floatTexts.forEach(t => { ctx.fillStyle=t.col; ctx.font="10px 'Press Start 2P'"; ctx.textAlign="center"; ctx.fillText(t.txt, t.x, t.y); });
    }

    function drawFlash(c, x, y, ang) {
        c.save(); c.translate(x, y-15); c.rotate(ang);
        // Smaller Flash
        let grd = c.createLinearGradient(0, 0, 100, 0); grd.addColorStop(0, "rgba(255,255,255,0.8)"); grd.addColorStop(1, "rgba(255,255,255,0)");
        c.fillStyle = grd; c.beginPath(); c.moveTo(0, 0); c.lineTo(100, -30); c.lineTo(100, 30); c.fill();
        c.restore();
    }

    function draw2DChar(c, d, x, y) {
        c.save(); c.translate(x, y); c.scale(d.facing, 1);
        if(d.hp !== undefined) {
            c.save(); c.scale(d.facing, 1);
            c.fillStyle = 'red'; c.fillRect(-15, -50, 30, 4); c.fillStyle = '#0f0'; c.fillRect(-15, -50, 30*(d.hp/100), 4);
            c.restore();
        }
        
        if(d.state === 'stunned') { c.rotate((Math.random()-0.5)*0.2); }

        let run = (d.state==='run'||d.state==='run_hold'||d.state==='drag') ? Math.sin(d.anim*0.3) : 0;
        c.strokeStyle = '#222'; c.lineWidth = 4; c.beginPath();
        c.moveTo(-4, -15); c.lineTo(-8-(run*6), 0); c.moveTo(4, -15); c.lineTo(8+(run*6), 0); c.stroke();

        if(d.type==='civ') {
            c.fillStyle=d.color; c.fillRect(-6,-28,12,16); c.fillStyle=C.skin; c.fillRect(-5,-36,10,8);
        } else if(d.type==='hero_wb' || d.type==='wb') {
            c.fillStyle=C.wbBlue; c.fillRect(-6,-28,12,16); c.fillStyle='#fff'; c.fillRect(-4,-28,8,4); c.fillStyle=C.skin; c.fillRect(-5,-36,10,8); c.fillStyle='#111'; c.fillRect(-6,-38,12,4); c.fillStyle='#222'; c.fillRect(4,-22,8,6);
        } else if(d.type==='hero_swat' || d.type==='swat') {
            c.fillStyle=C.swatBlack; c.fillRect(-7,-28,14,16); c.fillStyle='#111'; c.beginPath(); c.arc(0,-32,6,0,Math.PI*2); c.fill(); c.fillStyle=C.swatRed; c.fillRect(2,-34,6,2);
            // BATON: Draw for all SWAT
            if(d.type==='hero_swat' && hero.swingTimer>0 && d.hp!==undefined) {
                c.save(); c.translate(6, -22); c.rotate(Math.sin(hero.swingTimer)*2); c.fillStyle='#333'; c.fillRect(0,-20,3,25); c.restore();
            } else { c.fillStyle='#333'; c.fillRect(4,-24,2,12); }
        }
        c.restore();
    }
</script>
</body>
</html>
