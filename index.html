<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Safe The Uyghurs</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;overflow:hidden;background:#111;font-family:'Press Start 2P',cursive;touch-action:none;user-select:none;-webkit-user-select:none;}
canvas#gameCanvas{display:block;margin:0 auto;background-color:#dcb159;box-shadow:0 0 20px rgba(0,0,0,0.5);}

#ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column;z-index:5;}

#top-ui{padding:10px;display:flex;flex-direction:column;gap:5px;color:#fff;text-shadow:2px 2px 0 #000;font-size:10px;background:rgba(0,0,0,0.3);}
.stat-line{display:flex;justify-content:space-between;width:100%;}

/* HP / STAMINA */
#bars-wrap{position:absolute;top:8px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:3px;pointer-events:none;}
.bar-row{display:flex;align-items:center;gap:4px;}
.bar-lbl{font-size:6px;color:#ccc;width:14px;text-align:right;}
.bar-bg{width:100px;height:8px;background:#333;border:2px solid #555;overflow:hidden;}
.bar-fill{height:100%;width:100%;transition:width 0.08s;}
#hp-fill{background:#e74c3c;}
#sta-fill{background:#3498db;}
#score-wrap{position:absolute;top:48px;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none;}
#score-num{font-size:20px;color:#ffe066;text-shadow:0 0 10px #ffaa00,2px 2px 0 #000;}
#wave-lbl{font-size:8px;color:#ff8866;margin-top:2px;}
#combo-lbl{font-size:10px;color:#ff44cc;text-shadow:0 0 8px #ff44cc;display:none;margin-top:2px;}

/* SCREENS */
#start-screen,#game-over-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(18,24,33,0.98);display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;z-index:10;pointer-events:auto;text-align:center;}
#game-over-screen{display:none;}
#wave-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;z-index:15;pointer-events:none;align-items:center;justify-content:center;}
#wave-announce{font-size:clamp(30px,9vw,56px);color:#fff;text-shadow:0 0 25px #fff,2px 2px 0 #000;letter-spacing:6px;animation:wvf 0.35s steps(1) infinite;}
@keyframes wvf{0%{opacity:1;}50%{opacity:0.4;}}

h1{font-size:24px;color:#ffcc00;margin-bottom:5px;text-shadow:4px 4px 0 #8b0000;line-height:1.5;}
.mode-container{display:flex;flex-direction:column;gap:20px;margin-top:25px;width:80%;max-width:300px;align-items:center;}
.mode-card{border:2px solid #555;background:#222;padding:10px;width:100%;cursor:pointer;transition:all 0.1s;display:flex;flex-direction:row;align-items:center;gap:15px;border-radius:8px;text-align:left;}
.mode-card:active,.mode-card:hover{border-color:#ffcc00;background:#333;transform:scale(0.98);}
.mode-info{display:flex;flex-direction:column;}
.mode-title{font-size:12px;color:#ffcc00;margin-bottom:5px;}
.mode-desc{font-size:8px;color:#aaa;line-height:1.4;}
.btn{background:#d32f2f;border:4px solid #fff;padding:15px 30px;color:white;font-family:'Press Start 2P';font-size:16px;cursor:pointer;margin-top:20px;}

#go-text{font-size:10px;line-height:1.6;max-width:80%;color:#ccc;margin-bottom:20px;border-top:1px solid #555;border-bottom:1px solid #555;padding:10px 0;}
.stat-box{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;width:80%;}
.stat-row{display:flex;justify-content:space-between;font-size:12px;color:#fff;border-bottom:1px dashed #444;padding-bottom:5px;}
.hs-line{font-size:9px;color:#ffcc00;margin:4px 0;}

/* CONTROLS LAYOUT - LEFT joystick, RIGHT actions */
#controls-wrap{position:absolute;bottom:0;left:0;width:100%;height:210px;pointer-events:none;}
#joystick-zone{position:absolute;bottom:0;left:0;width:50%;height:210px;pointer-events:auto;}
#action-zone{position:absolute;bottom:0;right:0;width:50%;height:210px;pointer-events:auto;}

/* Action buttons positioned relative to #action-zone */
.game-btn{
  border-radius:50%;border:3px solid rgba(255,255,255,0.9);
  background:rgba(0,0,0,0.45);color:white;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;position:absolute;touch-action:manipulation;
  box-shadow:0 4px 12px rgba(0,0,0,0.6);
  flex-direction:column;gap:1px;
}
.game-btn:active{background:rgba(255,255,255,0.35);transform:scale(0.93);}
.btn-sub{font-size:5px;color:rgba(255,255,255,0.7);font-family:'Press Start 2P',cursive;line-height:1;}

/* Single flash btn for WB mode */
#btn-flash{width:85px;height:85px;right:35px;bottom:60px;border-color:rgba(80,200,255,0.9);}
/* Perp mode buttons */
#btn-kick {width:72px;height:72px;right:12px;bottom:100px;border-color:rgba(255,80,80,0.9);}
#btn-grab {width:72px;height:72px;right:95px;bottom:30px; border-color:rgba(80,160,255,0.9);}
#btn-taser{width:62px;height:62px;right:100px;bottom:118px;border-color:rgba(255,230,40,0.9);}

/* Joystick visual */
#joystick-ui{position:absolute;width:100px;height:100px;border:2px solid rgba(255,255,255,0.25);border-radius:50%;display:none;pointer-events:none;background:rgba(255,255,255,0.04);}
#joystick-stick{position:absolute;width:38px;height:38px;background:rgba(255,255,255,0.45);border-radius:50%;top:31px;left:31px;box-shadow:0 0 8px rgba(255,255,255,0.3);}

.hidden{display:none!important;}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer">
  <div id="top-ui"></div>

  <div id="bars-wrap">
    <div class="bar-row"><span class="bar-lbl">HP</span><div class="bar-bg"><div class="bar-fill" id="hp-fill"></div></div></div>
    <div class="bar-row"><span class="bar-lbl">SP</span><div class="bar-bg"><div class="bar-fill" id="sta-fill"></div></div></div>
  </div>
  <div id="score-wrap">
    <div id="score-num">0</div>
    <div id="wave-lbl">WAVE 1</div>
    <div id="combo-lbl">x2 COMBO!</div>
  </div>

  <div id="joystick-ui"><div id="joystick-stick"></div></div>

  <div id="controls-wrap">
    <div id="joystick-zone"></div>
    <div id="action-zone">
      <div id="btn-flash" class="game-btn hidden" ontouchstart="doAction('flash',event)">ğŸ“¸<span class="btn-sub">EXPOSE</span></div>
      <div id="btn-kick"  class="game-btn hidden" ontouchstart="doAction('kick',event)">ğŸ<span class="btn-sub">BATON</span></div>
      <div id="btn-grab"  class="game-btn hidden" ontouchstart="doAction('grab',event)">âœ‹<span class="btn-sub">GRAB</span></div>
      <div id="btn-taser" class="game-btn hidden" ontouchstart="doAction('taser',event)">âš¡<span class="btn-sub">TASER</span></div>
    </div>
  </div>
</div>

<!-- WAVE ANNOUNCE -->
<div id="wave-screen" style="display:none;"><div id="wave-announce">WAVE 1</div></div>

<!-- START SCREEN -->
<div id="start-screen">
  <h1>SAFE THE<br>UYGHURS</h1>
  <p style="font-size:10px;color:#aaa;margin-bottom:20px;">SELECT MODE</p>
  <div class="mode-container">
    <div class="mode-card" onclick="setMode('whistleblower')">
      <canvas id="p1-canvas" width="60" height="60"></canvas>
      <div class="mode-info">
        <div class="mode-title">WHISTLEBLOWER</div>
        <div class="mode-desc">Expose the truth.<br>Save them.</div>
      </div>
    </div>
    <div class="mode-card" onclick="setMode('perpetrator')">
      <canvas id="p2-canvas" width="60" height="60"></canvas>
      <div class="mode-info">
        <div class="mode-title">PERPETRATOR</div>
        <div class="mode-desc">Enforce order.<br>Stop intruders.</div>
      </div>
    </div>
  </div>
  <p style="font-size:7px;color:#555;margin-top:18px;max-width:260px;line-height:1.8;">
    This game raises awareness of the ongoing persecution of Uyghur people in Xinjiang, China.
  </p>
</div>

<!-- GAME OVER -->
<div id="game-over-screen">
  <h1 id="go-title" style="color:#ff5555">GAME OVER</h1>
  <div class="stat-box" id="stat-container"></div>
  <p id="go-text">...</p>
  <div class="hs-line" id="hs-line"></div>
  <button class="btn" onclick="showStartScreen()">MAIN MENU</button>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CANVAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;
function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener('resize', resize); resize();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PIXEL SPRITE ENGINE
// Sprites are 16Ã—24 pixel bitmaps drawn into
// offscreen canvases, then stamped at 2Ã— scale.
// Each sprite is defined as a 16Ã—24 array of
// colour indices; palette per sprite type.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCALE = 2; // final render scale
const SW = 16, SH = 24; // sprite logical pixels

// helper: build offscreen canvas from palette + map
function makeSprite(palette, map) {
  const oc = document.createElement('canvas');
  oc.width = SW * SCALE; oc.height = SH * SCALE;
  const oc2 = oc.getContext('2d');
  oc2.imageSmoothingEnabled = false;
  for (let r = 0; r < SH; r++) {
    for (let c = 0; c < SW; c++) {
      const idx = map[r * SW + c];
      if (idx === 0) continue;
      oc2.fillStyle = palette[idx];
      oc2.fillRect(c * SCALE, r * SCALE, SCALE, SCALE);
    }
  }
  return oc;
}

// â”€â”€ CIVILIAN SPRITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// palette: 1=skin 2=hair 3=shirt(varies) 4=pants 5=shoe 6=outline 7=white 8=mouth
const CIV_BASE = [
  0,0,0,0,0,6,6,6,6,6,0,0,0,0,0,0,  // row 0 â€” hair top
  0,0,0,0,6,2,2,2,2,2,6,0,0,0,0,0,  // 1
  0,0,0,6,2,2,2,2,2,2,2,6,0,0,0,0,  // 2
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,  // 3 head
  0,0,0,6,1,6,1,1,1,6,1,6,0,0,0,0,  // 4 eyes
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,  // 5
  0,0,0,6,1,1,6,1,6,1,1,6,0,0,0,0,  // 6 mouth
  0,0,0,0,6,6,6,6,6,6,6,0,0,0,0,0,  // 7 chin
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,  // 8 shoulders
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,  // 9
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,  // 10 torso wide
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,  // 11
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,  // 12
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,  // 13 hips
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,  // 14 upper leg
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,  // 15
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,  // 16 lower leg
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,  // 17
  0,0,6,5,5,6,0,0,6,5,5,6,0,0,0,0,  // 18 feet
  0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,  // 19
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];

// walking frame: legs offset
const CIV_WALK = [
  0,0,0,0,0,6,6,6,6,6,0,0,0,0,0,0,
  0,0,0,0,6,2,2,2,2,2,6,0,0,0,0,0,
  0,0,0,6,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,6,1,1,1,6,1,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,1,6,1,6,1,1,6,0,0,0,0,
  0,0,0,0,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,0,6,4,4,6,0,6,4,4,0,0,0,0,0,  // legs spread
  0,0,0,0,6,4,4,6,4,4,0,0,0,0,0,0,
  0,0,0,0,6,4,4,0,4,4,6,0,0,0,0,0,
  0,0,0,0,6,4,6,0,0,6,4,6,0,0,0,0,
  0,0,0,0,6,5,6,0,0,6,5,6,0,0,0,0,
  0,0,0,0,0,6,0,0,0,0,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];

// Civ palette variants (shirt colours)
function makeCivSprites(shirtCol, hairCol, skinCol) {
  const p = {
    1: skinCol || '#f5cba7',
    2: hairCol || '#111',
    3: shirtCol,
    4: '#555577',
    5: '#222',
    6: '#111',
    7: '#fff',
    8: '#c00'
  };
  return {
    idle: makeSprite(p, CIV_BASE),
    walk: makeSprite(p, CIV_WALK),
  };
}

// Pre-bake 6 civ variants
const CIV_VARIANTS = [
  makeCivSprites('#c0392b','#1a0a00','#f5cba7'),
  makeCivSprites('#2980b9','#222','#e8b89a'),
  makeCivSprites('#27ae60','#333','#d4956a'),
  makeCivSprites('#8e44ad','#111','#f0c08a'),
  makeCivSprites('#e67e22','#1a1208','#c89070'),
  makeCivSprites('#16a085','#444','#f5cba7'),
];

// â”€â”€ WHISTLEBLOWER SPRITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1=skin 2=darkhair 3=bluejacket 4=pants 5=shoe 6=outline 7=white 8=camera 9=lens 10=shirt
const WB_PAL = {
  1:'#f5cba7', 2:'#1a1208', 3:'#2980b9', 4:'#1a1f2e',
  5:'#111', 6:'#111', 7:'#fff', 8:'#222', 9:'#55aaff', 10:'#ecf0f1'
};
const WB_BASE = [
  0,0,0,0,0,6,6,6,6,6,6,0,0,0,0,0,
  0,0,0,0,6,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,6,1,1,1,6,1,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,1,6,1,1,6,1,6,0,0,0,0,
  0,0,0,0,6,6,1,6,1,6,6,0,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,6,3,3,10,10,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,8,8,6,  // camera held right
  0,0,6,3,3,3,3,3,3,3,3,6,8,9,8,6,
  0,0,6,4,4,6,0,0,6,4,4,6,0,6,6,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,5,5,6,0,0,6,5,5,6,0,0,0,0,
  0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];
const WB_WALK = [
  0,0,0,0,0,6,6,6,6,6,6,0,0,0,0,0,
  0,0,0,0,6,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,6,1,1,1,6,1,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,1,6,1,1,6,1,6,0,0,0,0,
  0,0,0,0,6,6,1,6,1,6,6,0,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,6,3,3,10,10,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,8,8,6,
  0,0,6,3,3,3,3,3,3,3,3,6,8,9,8,6,
  0,0,6,4,4,6,0,0,6,4,4,6,0,6,6,0,
  0,0,0,6,4,4,6,0,6,4,4,0,0,0,0,0,
  0,0,0,0,6,4,4,6,4,4,0,0,0,0,0,0,
  0,0,0,0,6,4,4,0,4,4,6,0,0,0,0,0,
  0,0,0,0,6,4,6,0,0,6,4,6,0,0,0,0,
  0,0,0,0,6,5,6,0,0,6,5,6,0,0,0,0,
  0,0,0,0,0,6,0,0,0,0,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];
const WB_FLASH = [  // camera raised + flash pose
  0,0,0,0,0,6,6,6,6,6,6,0,0,0,0,0,
  0,0,0,0,6,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,6,1,1,1,6,1,6,0,0,0,0,
  0,0,0,6,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,0,6,1,1,1,6,1,1,1,6,0,0,0,0, // mouth open
  0,0,0,0,6,6,6,6,6,6,6,0,0,0,0,0,
  0,6,8,8,3,3,3,3,3,3,3,6,0,0,0,0, // arm up with camera
  6,8,9,8,6,3,3,3,3,3,3,3,6,0,0,0,
  0,6,8,8,3,3,3,3,3,3,3,3,6,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,5,5,6,0,0,6,5,5,6,0,0,0,0,
  0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];
const WB_SPRITES = {
  idle: makeSprite(WB_PAL, WB_BASE),
  walk: makeSprite(WB_PAL, WB_WALK),
  flash: makeSprite(WB_PAL, WB_FLASH),
};

// â”€â”€ SWAT SPRITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1=helmet 2=visor(blue tint) 3=uniform 4=boots 5=baton 6=outline 7=badge(red) 8=glove 9=visorreflect
const SWAT_PAL = {
  1:'#1a1f28', 2:'rgba(30,80,120,0.85)', 3:'#1e272e', 4:'#111',
  5:'#444', 6:'#111', 7:'#c0392b', 8:'#2c2c2c', 9:'rgba(255,255,255,0.3)'
};
const SWAT_BASE = [
  0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,2,2,2,2,2,2,2,2,6,0,0,0,0,  // visor row
  0,0,6,2,9,9,2,2,2,2,2,6,0,0,0,0,  // visor shine
  0,0,6,2,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,7,7,3,3,3,3,3,3,6,0,0,0, // badge left chest
  0,6,3,3,3,3,3,3,3,3,3,3,6,5,5,6, // baton right
  0,0,6,3,3,3,3,3,3,3,3,6,5,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,5,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,5,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,5,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,0,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,0,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];
const SWAT_WALK = [
  0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,2,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,6,2,9,9,2,2,2,2,2,6,0,0,0,0,
  0,0,6,2,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,0,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,7,7,3,3,3,3,3,3,6,0,0,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,5,5,6,
  0,0,6,3,3,3,3,3,3,3,3,6,5,5,5,6,
  0,0,6,4,4,6,0,0,6,4,4,6,5,5,5,6,
  0,0,0,6,4,4,6,0,6,4,4,0,5,5,5,6, // stride
  0,0,0,0,6,4,4,6,4,4,0,0,0,5,5,6,
  0,0,0,0,6,4,4,0,4,4,6,0,0,5,5,6,
  0,0,0,0,6,4,6,0,0,6,4,6,0,0,0,0,
  0,0,0,0,6,4,6,0,0,6,4,6,0,0,0,0,
  0,0,0,0,0,6,0,0,0,0,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];
const SWAT_SWING = [  // baton raised to swing
  0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,1,1,1,1,1,1,1,1,6,0,0,0,0,
  0,0,6,2,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,6,2,9,9,2,2,2,2,2,6,0,0,0,0,
  0,0,6,2,2,2,2,2,2,2,2,6,0,0,0,0,
  0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0,
  0,0,6,3,3,3,3,3,3,3,3,6,5,6,0,0,  // arm + baton high
  0,6,3,3,3,3,3,3,3,3,3,3,6,5,6,0,
  0,6,3,3,7,7,3,3,3,3,3,3,6,5,6,0,
  0,6,3,3,3,3,3,3,3,3,3,3,6,5,6,0,
  0,0,6,3,3,3,3,3,3,3,3,6,5,6,0,0,
  0,0,6,4,4,6,0,0,6,4,4,8,6,0,0,0,  // glove
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,6,4,4,6,0,0,6,4,4,6,0,0,0,0,
  0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
];
const SWAT_SPRITES = {
  idle:  makeSprite(SWAT_PAL, SWAT_BASE),
  walk:  makeSprite(SWAT_PAL, SWAT_WALK),
  swing: makeSprite(SWAT_PAL, SWAT_SWING),
};

// â”€â”€ STUNNED OVERLAY (X eyes) on small square â”€
function makeStunOverlay() {
  const oc = document.createElement('canvas');
  oc.width = SW*SCALE; oc.height = SH*SCALE;
  const c = oc.getContext('2d');
  c.fillStyle='#ff0'; c.font=`${SCALE*5}px monospace`; c.textAlign='center';
  c.fillText('âœ•âœ•', (SW*SCALE)/2, SCALE*6);
  return oc;
}
const STUN_OVL = makeStunOverlay();

// â”€â”€ PORTRAIT canvases (re-use full sprites) â”€â”€
function drawPortraitSprite(canvasEl, sprites) {
  const c = canvasEl.getContext('2d');
  c.imageSmoothingEnabled = false;
  c.clearRect(0,0,60,60);
  c.fillStyle = '#1a1a2e';
  c.fillRect(0,0,60,60);
  // scale up to fit portrait
  const sc = 60 / (SH*SCALE);
  c.save(); c.scale(sc*1.4, sc*1.4); c.translate(0, 0);
  c.drawImage(sprites.idle, -4, 0);
  c.restore();
}
setTimeout(()=>{
  drawPortraitSprite(document.getElementById('p1-canvas'), WB_SPRITES);
  drawPortraitSprite(document.getElementById('p2-canvas'), SWAT_SPRITES);
}, 80);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WEB AUDIO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _audioCtx = null;
function getAudio(){ if(!_audioCtx) _audioCtx=new(window.AudioContext||window.webkitAudioContext)(); return _audioCtx; }
function playTone(f,t,d,v=0.15,dcy=0.5){ try{ const a=getAudio(),o=a.createOscillator(),g=a.createGain(); o.type=t; o.frequency.setValueAtTime(f,a.currentTime); o.frequency.exponentialRampToValueAtTime(f*dcy,a.currentTime+d); g.gain.setValueAtTime(v,a.currentTime); g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d); o.connect(g); g.connect(a.destination); o.start(); o.stop(a.currentTime+d); }catch(e){} }
function playNoise(d,v=0.1){ try{ const a=getAudio(),b=a.createBuffer(1,a.sampleRate*d,a.sampleRate),dt=b.getChannelData(0); for(let i=0;i<dt.length;i++) dt[i]=Math.random()*2-1; const s=a.createBufferSource(),g=a.createGain(); s.buffer=b; g.gain.setValueAtTime(v,a.currentTime); g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d); s.connect(g); g.connect(a.destination); s.start(); }catch(e){} }
const sfx = {
  flash:()=>{ playTone(800,'sine',0.12,0.25,0.3); playNoise(0.08,0.2); },
  kick: ()=>{ playTone(160,'sawtooth',0.1,0.28,0.1); playNoise(0.07,0.2); },
  taser:()=>{ playTone(320,'square',0.18,0.18,1.8); playTone(640,'square',0.14,0.12,1.8); },
  hit:  ()=>{ playTone(130,'sawtooth',0.1,0.22,0.15); },
  free: ()=>{ playTone(440,'sine',0.05); setTimeout(()=>playTone(660,'sine',0.1,0.1),70); },
  score:()=>{ playTone(440,'sine',0.06); setTimeout(()=>playTone(880,'sine',0.1,0.1),80); },
  death:()=>{ playTone(200,'sawtooth',0.28,0.28,0.1); playNoise(0.18,0.28); },
  wave: ()=>{ [220,330,440,660].forEach((f,i)=>setTimeout(()=>playTone(f,'sine',0.2,0.18),i*75)); },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WIRE_Y = 185;
const LS_KEY = 'stu_v2_hs';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let GAME_MODE='whistleblower', gameActive=false, frame=0, score=0;
let wave=1, waveTimer=0, waveShowing=false;
let screenShake={intensity:0,x:0,y:0};
let comboCount=0, comboTimer=0;
let stats={escaped:0,detained:0,silenced:0,exposed:0,lost:0};
let cooldowns={flash:0,kick:0,taser:0};

let hero={
  x:0,y:0,speed:3.8,hp:100,maxHp:100,
  angle:-Math.PI/2,facing:1,
  state:'idle',holding:null,
  flashTimer:0,swingTimer:0,speedBoost:0,
  stamina:100,maxStamina:100,invincible:0,
};

let entities=[],items=[],particles=[],floatTexts=[],taserBolts=[],smokeParticles=[],bloodSplats=[],obstacles=[];
let entityIdCtr=0;

let joystick={on:false,id:null,sx:0,sy:0,cx:0,cy:0};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HIGH SCORES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getHS(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
function saveHS(mode,val){ const h=getHS(); const k=mode==='whistleblower'?'wb':'perp'; if(val>(h[k]||0)){ h[k]=val; try{ localStorage.setItem(LS_KEY,JSON.stringify(h)); }catch(e){} } }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOYSTICK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const joyZone=document.getElementById('joystick-zone');
const joyUI=document.getElementById('joystick-ui');
const joyStick=document.getElementById('joystick-stick');

joyZone.addEventListener('touchstart',e=>{
  e.preventDefault(); const t=e.changedTouches[0];
  joystick.on=true; joystick.id=t.identifier;
  joystick.sx=t.clientX; joystick.sy=t.clientY;
  joystick.cx=t.clientX; joystick.cy=t.clientY;
  joyUI.style.display='block';
  joyUI.style.left=(t.clientX-50)+'px'; joyUI.style.top=(t.clientY-50)+'px';
  joyStick.style.left='31px'; joyStick.style.top='31px';
},{passive:false});

joyZone.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(const t of e.changedTouches) if(joystick.on&&t.identifier===joystick.id){
    joystick.cx=t.clientX; joystick.cy=t.clientY;
    const dx=t.clientX-joystick.sx,dy=t.clientY-joystick.sy;
    const d=Math.min(Math.hypot(dx,dy),32),ang=Math.atan2(dy,dx);
    joyStick.style.left=(31+Math.cos(ang)*d)+'px'; joyStick.style.top=(31+Math.sin(ang)*d)+'px';
  }
},{passive:false});

['touchend','touchcancel'].forEach(ev=>joyZone.addEventListener(ev,e=>{
  e.preventDefault();
  for(const t of e.changedTouches) if(joystick.on&&t.identifier===joystick.id){ joystick.on=false; joyUI.style.display='none'; }
},{passive:false}));

// Keyboard
const keys={};
window.addEventListener('keydown',e=>{ keys[e.key]=true; if(e.key===' ') doAction(GAME_MODE==='whistleblower'?'flash':'kick'); if(e.key==='e'||e.key==='E') doAction('grab'); if(e.key==='q'||e.key==='Q') doAction('taser'); });
window.addEventListener('keyup',e=>{ keys[e.key]=false; });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OBSTACLES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genObstacles(){
  obstacles=[];
  const rows=3, cols=4;
  const cw=canvas.width/(cols+1), rh=(canvas.height-WIRE_Y-80)/(rows+1);
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    if(Math.random()<0.55){
      obstacles.push({
        x:cw*(c+1)+(Math.random()-0.5)*40-16,
        y:WIRE_Y+rh*(r+1)+(Math.random()-0.5)*30-8,
        w:20+Math.floor(Math.random()*28),
        h:14+Math.floor(Math.random()*14),
      });
    }
  }
}

function obstacleBlock(nx,ny,r=10){
  for(const o of obstacles){
    if(nx>o.x-r&&nx<o.x+o.w+r&&ny>o.y-r&&ny<o.y+o.h+r){
      return true;
    }
  }
  return false;
}
function slideObstacle(ent,mx,my,r=10){
  let nx=ent.x+mx, ny=ent.y+my;
  if(!obstacleBlock(nx,ent.y,r)) return {x:nx,y:ent.y};
  if(!obstacleBlock(ent.x,ny,r)) return {x:ent.x,y:ny};
  return {x:ent.x,y:ent.y};
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME FLOW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(mode){
  GAME_MODE=mode;
  ['btn-flash','btn-kick','btn-grab','btn-taser'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(mode==='whistleblower') document.getElementById('btn-flash').classList.remove('hidden');
  else { document.getElementById('btn-kick').classList.remove('hidden'); document.getElementById('btn-grab').classList.remove('hidden'); document.getElementById('btn-taser').classList.remove('hidden'); }
  startGame();
}

function showStartScreen(){
  document.getElementById('start-screen').style.display='flex';
  document.getElementById('game-over-screen').style.display='none';
  gameActive=false;
}

function startGame(){
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-over-screen').style.display='none';
  hero.x=canvas.width/2; hero.y=canvas.height-170;
  hero.hp=100; hero.stamina=100; hero.angle=-Math.PI/2; hero.holding=null;
  hero.flashTimer=0; hero.swingTimer=0; hero.speedBoost=0; hero.invincible=0;
  entities=[]; items=[]; particles=[]; floatTexts=[]; taserBolts=[]; smokeParticles=[]; bloodSplats=[];
  score=0; frame=0; wave=1; waveTimer=0; comboCount=0; comboTimer=0;
  stats={escaped:0,detained:0,silenced:0,exposed:0,lost:0};
  cooldowns={flash:0,kick:0,taser:0};
  genObstacles();
  if(GAME_MODE==='perpetrator'){ spawnEntity('swat_ally'); spawnEntity('swat_ally'); }
  announceWave(1);
  gameActive=true;
  loop();
}

function announceWave(w){
  const ws=document.getElementById('wave-screen');
  const wa=document.getElementById('wave-announce');
  wa.textContent=w===1?'BEGIN!':'WAVE '+w;
  ws.style.display='flex'; waveShowing=true; sfx.wave();
  setTimeout(()=>{ ws.style.display='none'; waveShowing=false; },1700);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop(){
  if(!gameActive) return;
  update(); draw(); updateTopUI(); frame++;
  requestAnimationFrame(loop);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UPDATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update(){
  // Timers
  if(hero.flashTimer>0) hero.flashTimer--;
  if(hero.swingTimer>0) hero.swingTimer--;
  if(hero.speedBoost>0) hero.speedBoost--;
  if(hero.invincible>0) hero.invincible--;
  for(const k in cooldowns) if(cooldowns[k]>0) cooldowns[k]--;
  if(comboTimer>0){ comboTimer--; if(comboTimer===0){ comboCount=0; document.getElementById('combo-lbl').style.display='none'; } }

  // Shake
  screenShake.intensity*=0.82;
  screenShake.x=(Math.random()-.5)*screenShake.intensity;
  screenShake.y=(Math.random()-.5)*screenShake.intensity;

  // Stamina regen
  hero.stamina=Math.min(hero.maxStamina, hero.stamina+0.22);

  // Bars
  document.getElementById('hp-fill').style.width=(hero.hp/hero.maxHp*100)+'%';
  document.getElementById('hp-fill').style.background=hero.hp>50?'#27ae60':hero.hp>25?'#e67e22':'#e74c3c';
  document.getElementById('sta-fill').style.width=(hero.stamina/hero.maxStamina*100)+'%';
  document.getElementById('score-num').textContent=score;
  document.getElementById('wave-lbl').textContent='WAVE '+wave;

  // â”€â”€ Hero movement â”€â”€
  let mx=0,my=0;
  const spd=hero.speed*(hero.speedBoost>0?1.55:1)*(hero.holding?0.55:1);

  if(joystick.on){
    const dx=joystick.cx-joystick.sx, dy=joystick.cy-joystick.sy, d=Math.hypot(dx,dy);
    if(d>10){
      hero.angle=Math.atan2(dy,dx);
      mx=Math.cos(hero.angle)*spd; my=Math.sin(hero.angle)*spd;
      hero.state='walk'; hero.facing=Math.abs(hero.angle)>Math.PI/2?-1:1;
    } else hero.state='idle';
  } else {
    let kx=0,ky=0;
    if(keys['ArrowLeft']||keys['a']) kx=-1;
    if(keys['ArrowRight']||keys['d']) kx=1;
    if(keys['ArrowUp']||keys['w']) ky=-1;
    if(keys['ArrowDown']||keys['s']) ky=1;
    if(kx||ky){
      hero.angle=Math.atan2(ky,kx);
      mx=kx*spd; my=ky*spd;
      hero.state='walk'; hero.facing=kx<0?-1:kx>0?1:hero.facing;
    } else hero.state='idle';
  }

  if(mx||my){
    const res=slideObstacle(hero,mx,my,13);
    hero.x=res.x; hero.y=res.y;
  }
  hero.x=Math.max(18,Math.min(canvas.width-18,hero.x));
  hero.y=Math.min(canvas.height-18,hero.y);

  if(GAME_MODE==='whistleblower'){
    if(hero.y<WIRE_Y) hero.y=WIRE_Y;
  } else {
    if(hero.holding&&Math.abs(hero.x-canvas.width/2)<65){
      if(hero.y<125){
        sfx.score(); score++;
        if(hero.holding.type==='civ') stats.detained++;
        else if(hero.holding.type==='wb') stats.silenced++;
        addCombo(); spawnFT(hero.x,hero.y,hero.holding.type==='wb'?"SILENCED":"DETAINED",hero.holding.type==='wb'?"#ff4444":"#fff");
        hero.holding.dead=true; hero.holding=null; hero.y=WIRE_Y+15; shake(5);
      }
    } else if(hero.y<WIRE_Y) hero.y=WIRE_Y;
  }

  // â”€â”€ Smoke â”€â”€
  if(frame%6===0){
    [[canvas.width/2-80],[canvas.width/2+80],[canvas.width/2+145]].forEach(([sx])=>{
      smokeParticles.push({x:sx+(Math.random()-.5)*8,y:16,vx:(Math.random()-.5)*0.35,vy:-.75-Math.random()*.35,life:140,size:1.5+Math.random()*2.5});
    });
  }

  // â”€â”€ Spawn â”€â”€
  const wv=1+(wave-1)*0.14;
  if(frame%100===0) spawnEntity('civ');
  const baseRate=GAME_MODE==='whistleblower'?Math.max(38,155-score*3):Math.max(55,265-score*2);
  if(frame%Math.floor(baseRate/wv)===0){ if(GAME_MODE==='whistleblower') spawnEntity('swat_enemy'); else spawnEntity('wb_enemy'); }
  if(frame%420===0) spawnItem();
  if(waveTimer>=1100+wave*280){ wave++; waveTimer=0; genObstacles(); announceWave(wave); if(GAME_MODE==='perpetrator') spawnEntity('swat_ally'); }
  waveTimer++;

  // â”€â”€ Taser bolts â”€â”€
  taserBolts.forEach(b=>{
    b.x+=Math.cos(b.angle)*11; b.y+=Math.sin(b.angle)*11; b.life--;
    entities.forEach(e=>{
      if(!e.dead&&(e.type==='civ'||e.type==='wb')&&dist(b,e)<20){
        b.dead=true; e.taserHits=(e.taserHits||0)+1; sfx.hit();
        if(e.taserHits>=2){ e.dead=true; spawnExplosion(e.x,e.y); if(e.type==='wb'){score++;stats.silenced++;addCombo();spawnFT(e.x,e.y,"SILENCED","#f00");} else spawnFT(e.x,e.y,"DOWN","#f00"); }
        else { e.state='stunned'; e.stunTimer=90; spawnFT(e.x,e.y,"ZAPPED","#ff0"); }
      }
    });
  });
  taserBolts=taserBolts.filter(b=>b.life>0&&!b.dead);

  // â”€â”€ Entities â”€â”€
  entities.forEach(e=>{ if(e.dead) return; if(e.stunTimer>0){e.stunTimer--;if(e.stunTimer===0&&e.state==='stunned')e.state='run';} updateEntity(e); });

  // Held entity follows hero
  if(hero.holding){ hero.holding.x=hero.x-(hero.facing*18); hero.holding.y=hero.y; hero.holding.state='stunned'; hero.holding.beingDragged=true; }

  entities=entities.filter(e=>!e.dead);

  // â”€â”€ Items â”€â”€
  items.forEach(i=>{
    if(i.dead) return; i.life--;
    if(i.life<0){i.dead=true;return;}
    if(dist(hero,i)<36){ i.dead=true; applyItem(i); }
  });
  items=items.filter(i=>!i.dead);

  // â”€â”€ Particles / texts â”€â”€
  particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.08;p.life--;});
  particles=particles.filter(p=>p.life>0);
  smokeParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life--;p.size+=0.04;});
  smokeParticles=smokeParticles.filter(p=>p.life>0);
  floatTexts.forEach(t=>{t.y-=0.55;t.life--;});
  floatTexts=floatTexts.filter(t=>t.life>0);
}

function updateEntity(e){
  if(e.type==='civ'){
    if(e.state==='run'){ e.y+=e.speed; e.x+=Math.sin(frame*0.04+e.id*6)*0.5; e.x=Math.max(15,Math.min(canvas.width-15,e.x));
      if(obstacleBlock(e.x,e.y)) e.y-=e.speed;
      if(e.y>canvas.height+20){ e.dead=true;
        if(GAME_MODE==='whistleblower'){ score++; stats.escaped++; addCombo(); sfx.score(); spawnFT(e.x,canvas.height-20,"+1 SAFE","#0f0"); }
        else stats.escaped++;
      }
    }
  }
  if(e.type==='swat'&&e.team==='enemy'){
    const dh=dist(e,hero);
    let nc=entities.find(c=>c.type==='civ'&&!c.dead&&!c.beingDragged&&c.y>WIRE_Y);
    let dc=nc?dist(e,nc):9999;
    let tgt=null,act='idle';
    if(hero.hp>0&&dh<165){if(!nc||dh<dc){tgt=hero;act='attack';}else{tgt=nc;act='capture';}}
    else if(nc){tgt=nc;act='capture';}
    if(tgt){
      const ang=Math.atan2(tgt.y-e.y,tgt.x-e.x); e.angle=ang; e.facing=Math.abs(ang)>Math.PI/2?-1:1;
      const rng=act==='capture'?22:38;
      if(dist(e,tgt)>rng){const res=slideObstacle(e,Math.cos(ang)*e.speed,Math.sin(ang)*e.speed);e.x=res.x;e.y=res.y;e.state='run';}
      else{ e.state='idle'; if(frame%32===0){ if(act==='attack') damageHero(8+wave); if(act==='capture'){ if(tgt.state!=='stunned'){tgt.state='stunned';tgt.stunTimer=110;spawnBlood(tgt.x,tgt.y);}else{e.holding=tgt;tgt.beingDragged=true;}}}}
    }
    if(e.holding){ const ang=Math.atan2(80-e.y,canvas.width/2-e.x); e.x+=Math.cos(ang)*e.speed*.9; e.y+=Math.sin(ang)*e.speed*.9; e.holding.x=e.x;e.holding.y=e.y; if(e.y<125){e.holding.dead=true;e.holding=null;stats.lost++;sfx.death();shake(5);spawnFT(e.x,e.y,"TAKEN","#f44");} }
    else if(e.y<WIRE_Y) e.y=WIRE_Y;
  }
  if(e.type==='swat'&&e.team==='ally'){
    if(e.holding){ const ang=Math.atan2(80-e.y,canvas.width/2-e.x); e.x+=Math.cos(ang)*e.speed*.9; e.y+=Math.sin(ang)*e.speed*.9; e.holding.x=e.x-(e.facing*12);e.holding.y=e.y; if(e.y<125){score++;stats.detained++;e.holding.dead=true;e.holding=null;spawnFT(e.x,e.y,"+1 ALLY","#aaa");} }
    else{ const tgt=entities.find(c=>c.type==='civ'&&c.state==='stunned'&&!c.beingDragged&&c.y>WIRE_Y); if(tgt){const ang=Math.atan2(tgt.y-e.y,tgt.x-e.x);e.angle=ang;e.facing=Math.abs(ang)>Math.PI/2?-1:1; if(dist(e,tgt)>22){const res=slideObstacle(e,Math.cos(ang)*e.speed,Math.sin(ang)*e.speed);e.x=res.x;e.y=res.y;e.state='run';}else{e.holding=tgt;tgt.beingDragged=true;}} else{const ang=Math.atan2((hero.y-50)-e.y,hero.x-e.x); if(dist(e,hero)>85){const res=slideObstacle(e,Math.cos(ang)*e.speed,Math.sin(ang)*e.speed);e.x=res.x;e.y=res.y;e.state='run';}else e.state='idle';} }
  }
  if(e.type==='wb'){
    if(e.y<WIRE_Y+55) e.y=WIRE_Y+55;
    const d=dist(e,hero); const ang=Math.atan2(hero.y-e.y,hero.x-e.x); e.angle=ang; e.facing=Math.abs(ang)>Math.PI/2?-1:1;
    if(d>205){const res=slideObstacle(e,Math.cos(ang)*e.speed,Math.sin(ang)*e.speed);e.x=res.x;e.y=res.y;e.state='run';}
    else if(d<100){e.x-=Math.cos(ang)*e.speed;e.y-=Math.sin(ang)*e.speed;e.state='run';}
    else{e.state='idle';if(frame%55===0&&Math.random()<.75){e.flashTimer=18;damageHero(7+wave);}}
    if(e.flashTimer>0) e.flashTimer--;
    e.x=Math.max(10,Math.min(canvas.width-10,e.x)); e.y=Math.max(WIRE_Y+50,Math.min(canvas.height-10,e.y));
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doAction(a,ev){
  if(ev){ev.preventDefault();ev.stopPropagation();}
  if(!gameActive||waveShowing) return;
  try{getAudio();}catch(e){}

  if(a==='flash'&&cooldowns.flash<=0){
    if(hero.stamina<20){spawnFT(hero.x,hero.y,"LOW STAMINA","#f88");return;}
    hero.stamina-=20; cooldowns.flash=22; hero.flashTimer=10; sfx.flash(); shake(3);
    entities.forEach(t=>{
      const diff=normalizeAngle(Math.atan2(t.y-hero.y,t.x-hero.x)-hero.angle);
      if(dist(hero,t)<112&&Math.abs(diff)<0.46){
        if(t.type==='civ'&&t.state==='stunned'){t.state='run';t.beingDragged=false;t.stunTimer=0;sfx.free();spawnFT(t.x,t.y,"FREED!","#0f0");}
        if(t.type==='swat'&&t.team==='enemy'){t.dead=true;if(t.holding){t.holding.beingDragged=false;t.holding.state='run';}spawnExplosion(t.x,t.y);score++;stats.exposed++;addCombo();sfx.score();shake(5);spawnFT(t.x,t.y,"EXPOSED","#fff");}
      }
    });
  }
  else if(a==='kick'&&cooldowns.kick<=0){
    if(hero.stamina<15){spawnFT(hero.x,hero.y,"LOW STAMINA","#f88");return;}
    hero.stamina-=15; cooldowns.kick=18; hero.swingTimer=12; sfx.kick(); shake(4);
    entities.forEach(t=>{
      if(dist(hero,t)<62&&!t.dead&&(t.type==='wb'||t.type==='civ')){
        spawnBlood(t.x,t.y); t.hits=(t.hits||0)+1;
        if(t.hits>=3){t.dead=true;spawnExplosion(t.x,t.y);if(t.type==='wb'){score++;stats.silenced++;addCombo();spawnFT(t.x,t.y,"SILENCED","#f00");}else spawnFT(t.x,t.y,"DOWN","#f00");}
        else{t.state='stunned';t.stunTimer=80;spawnFT(t.x,t.y,"BATON!","#ff0");}
      }
    });
  }
  else if(a==='grab'){
    if(hero.holding){hero.holding.state='run';hero.holding.beingDragged=false;hero.holding.stunTimer=0;hero.holding=null;}
    else{const t=entities.find(e=>(e.type==='civ'||(e.type==='wb'&&e.state==='stunned'))&&dist(hero,e)<52&&e.y>=WIRE_Y&&!e.beingDragged);if(t){hero.holding=t;spawnFT(hero.x,hero.y,"GRAB","#fff");}}
  }
  else if(a==='taser'&&cooldowns.taser<=0){
    if(hero.stamina<25){spawnFT(hero.x,hero.y,"LOW STAMINA","#f88");return;}
    hero.stamina-=25; cooldowns.taser=38; sfx.taser();
    taserBolts.push({x:hero.x,y:hero.y,angle:hero.angle,life:32});
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SPAWN / HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnEntity(type){
  let x=canvas.width/2+(Math.random()*280-140), y=WIRE_Y+8;
  if(type==='wb_enemy') y=canvas.height+8;
  const e={id:entityIdCtr++,x,y,dead:false,anim:Math.random()*10,angle:Math.PI/2,facing:1,type,team:'neutral',state:'run',stunTimer:0,hits:0,taserHits:0,beingDragged:false,holding:null,flashTimer:0};
  if(type==='civ'){e.civVar=Math.floor(Math.random()*CIV_VARIANTS.length);e.speed=0.9+Math.random()*0.75;}
  else if(type==='swat_enemy'){e.type='swat';e.team='enemy';e.speed=2.1+wave*0.14+Math.random()*0.4;}
  else if(type==='swat_ally'){e.type='swat';e.team='ally';e.speed=2.3;}
  else if(type==='wb_enemy'){e.type='wb';e.speed=3.4+wave*0.1;}
  entities.push(e);
}

function spawnItem(){
  const y=WIRE_Y+40+Math.random()*(canvas.height-WIRE_Y-80);
  const x=40+Math.random()*(canvas.width-80);
  if(GAME_MODE==='whistleblower') items.push({type:'film',x,y,life:700,dead:false});
  else{ const ts=['medkit','medkit','boot'];items.push({type:ts[Math.floor(Math.random()*ts.length)],x,y,life:700,dead:false}); }
}

function applyItem(i){
  if(i.type==='film'&&GAME_MODE==='whistleblower'){hero.hp=Math.min(hero.maxHp,hero.hp+30);sfx.free();spawnFT(hero.x,hero.y,"+EVIDENCE","#0f0");}
  else if(i.type==='medkit'){hero.hp=Math.min(hero.maxHp,hero.hp+35);sfx.free();spawnFT(hero.x,hero.y,"+35 HP","#0f0");}
  else if(i.type==='boot'){hero.speedBoost=400;sfx.free();spawnFT(hero.x,hero.y,"SPEED!","#44f");}
}

function addCombo(){ comboCount++; comboTimer=120; if(comboCount>1){ const cl=document.getElementById('combo-lbl'); cl.style.display='block'; cl.textContent='x'+comboCount+' COMBO!'; } score+=Math.max(0,comboCount-1); }
function spawnFT(x,y,txt,col){ floatTexts.push({x,y,txt,col,life:70}); }
function spawnExplosion(x,y){ for(let i=0;i<14;i++) particles.push({x,y,vx:(Math.random()-.5)*9,vy:(Math.random()-.5)*9-2,color:Math.random()<.5?'#000':'#444',life:22,size:3+Math.random()*3}); shake(5); }
function spawnBlood(x,y){ for(let i=0;i<9;i++) particles.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6-1,color:'#8b0000',life:28,size:2+Math.random()*3}); bloodSplats.push({x,y,r:3+Math.random()*7,a:.65}); }
function damageHero(a){ if(hero.invincible>0) return; hero.hp-=a; hero.invincible=16; spawnBlood(hero.x,hero.y); sfx.hit(); shake(6); spawnFT(hero.x,hero.y,'-'+a+' HP','#f44'); if(hero.hp<=0){hero.hp=0;gameOver();} }
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function normalizeAngle(a){ while(a>Math.PI)a-=Math.PI*2; while(a<-Math.PI)a+=Math.PI*2; return a; }
function shake(i){ screenShake.intensity=Math.max(screenShake.intensity,i); }

function updateTopUI(){
  const ui=document.getElementById('top-ui');
  if(GAME_MODE==='whistleblower')
    ui.innerHTML=`<div class="stat-line"><span style="color:#0f0">ESCAPED: ${stats.escaped}</span><span style="color:#f00">LOST: ${stats.lost}</span></div><div class="stat-line"><span style="color:#fff">EXPOSED: ${stats.exposed}</span></div>`;
  else
    ui.innerHTML=`<div class="stat-line"><span style="color:#f00">SILENCED: ${stats.silenced}</span><span style="color:#aaa">DETAINED: ${stats.detained}</span></div><div class="stat-line"><span style="color:#0f0">ESCAPED: ${stats.escaped}</span></div>`;
}

function gameOver(){
  gameActive=false; saveHS(GAME_MODE,score);
  const hs=getHS(); const hk=GAME_MODE==='whistleblower'?'wb':'perp';
  document.getElementById('game-over-screen').style.display='flex';
  document.getElementById('go-title').textContent=GAME_MODE==='whistleblower'?'MISSION ENDED':'WORK COMPLETE';
  const con=document.getElementById('stat-container'); con.innerHTML='';
  const row=(l,v)=>{const d=document.createElement('div');d.className='stat-row';d.innerHTML=`<span>${l}</span><span>${v}</span>`;con.appendChild(d);};
  if(GAME_MODE==='perpetrator'){
    row('Score',score);row('Wave',wave);row('Silenced WBs',stats.silenced);row('Uyghurs Detained',stats.detained);row('Uyghurs Escaped',stats.escaped);
    document.getElementById('go-text').textContent=`Congratulations, you are now a direct perpetrator of the Uyghur genocide. You successfully detained ${stats.detained} Uyghurs. The Party thanks you. You can now continue your comfortable life and enjoy cheap products made through forced labor.`;
  } else {
    row('Score',score);row('Wave',wave);row('People Escaped',stats.escaped);row('Perpetrators Exposed',stats.exposed);row('People Lost',stats.lost);
    document.getElementById('go-text').textContent=`Dear Whistleblower, thank you very much for exposing the Uyghur genocide to the world. Your footage has saved ${stats.escaped} lives.`;
  }
  document.getElementById('hs-line').textContent=score>=(hs[hk]||0)?'â˜… NEW HIGH SCORE: '+score:'BEST: '+(hs[hk]||0);
  sfx.death();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DRAW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw(){
  ctx.save();
  ctx.translate(Math.round(screenShake.x), Math.round(screenShake.y));

  // Ground
  ctx.fillStyle='#d4b480'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#c09a60';
  for(let i=0;i<canvas.width;i+=32) for(let j=WIRE_Y;j<canvas.height;j+=32) if((i+j)%96===0) ctx.fillRect(i,j,3,3);

  // Camp
  drawCamp();

  // Wire fence
  ctx.strokeStyle='#111'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.moveTo(0,WIRE_Y-3); ctx.lineTo(canvas.width,WIRE_Y-3); ctx.stroke();
  ctx.lineWidth=1.5; ctx.strokeStyle='#333';
  for(let i=0;i<canvas.width;i+=18){ ctx.beginPath(); ctx.moveTo(i,WIRE_Y-8); ctx.lineTo(i+9,WIRE_Y+2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(i+9,WIRE_Y-8); ctx.lineTo(i,WIRE_Y+2); ctx.stroke(); }

  // Obstacles (sandbag piles)
  obstacles.forEach(o=>{
    ctx.fillStyle='#4a4030'; ctx.fillRect(o.x,o.y,o.w,o.h);
    ctx.fillStyle='#5a5040'; ctx.fillRect(o.x,o.y+2,o.w,4);
    ctx.fillStyle='#3a3020'; ctx.fillRect(o.x,o.y+o.h-3,o.w,3);
    // bag segments
    const bw=Math.floor(o.w/3);
    for(let s=0;s<3;s++){ ctx.fillStyle=s%2?'#5a5040':'#4a4030'; ctx.fillRect(o.x+s*bw,o.y,bw,o.h); }
    ctx.strokeStyle='#222'; ctx.lineWidth=1; ctx.strokeRect(o.x,o.y,o.w,o.h);
  });

  // Blood splats
  bloodSplats.forEach(s=>{ ctx.save(); ctx.globalAlpha=s.a*0.45; ctx.fillStyle='#6b0000'; ctx.beginPath(); ctx.ellipse(s.x,s.y,s.r,s.r*.6,0,0,Math.PI*2); ctx.fill(); ctx.restore(); });

  // Items
  drawItems();

  // Taser bolts
  taserBolts.forEach(b=>{
    ctx.strokeStyle='#ffe800'; ctx.lineWidth=2; ctx.shadowColor='#ffe800'; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.x-Math.cos(b.angle)*10,b.y-Math.sin(b.angle)*10); ctx.stroke();
    ctx.shadowBlur=0;
  });

  // Shadows
  entities.forEach(e=>{ ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.beginPath(); ctx.ellipse(e.x,e.y+2,SW*SCALE*.38,4,0,0,Math.PI*2); ctx.fill(); });
  ctx.fillStyle='rgba(0,0,0,0.22)'; ctx.beginPath(); ctx.ellipse(hero.x,hero.y+2,SW*SCALE*.42,5,0,0,Math.PI*2); ctx.fill();

  // Draw entities (sprites)
  entities.forEach(e=>drawEntitySprite(e));
  drawHeroSprite();

  // Flash cone
  if(hero.flashTimer>0) drawFlash(hero.x,hero.y-SW*SCALE*.4,hero.angle);
  entities.forEach(e=>{ if(e.type==='wb'&&e.flashTimer>0) drawFlash(e.x,e.y-SW*SCALE*.4,e.angle); });

  // Smoke
  smokeParticles.forEach(p=>{ ctx.fillStyle=`rgba(25,25,25,${Math.min(.55,p.life/140)})`; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); });

  // Particles
  particles.forEach(p=>{ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); });

  // Float texts
  ctx.textAlign='center';
  floatTexts.forEach(t=>{
    ctx.font="bold 11px 'Press Start 2P',monospace";
    ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillText(t.txt,t.x+1,t.y+1);
    ctx.fillStyle=t.col; ctx.fillText(t.txt,t.x,t.y);
  });

  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SPRITE STAMPING
// Each sprite is SWÃ—SH logical pixels @ SCALE.
// We stamp them centered on (x, y) â€” y is feet.
// For flipped (facing=-1), use ctx scale trick.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPW = SW * SCALE;  // sprite pixel width  = 32
const SPH = SH * SCALE;  // sprite pixel height = 48

function stampSprite(spr, x, y, facing, alpha=1){
  if(!spr) return;
  ctx.save();
  if(alpha<1) ctx.globalAlpha=alpha;
  ctx.translate(Math.round(x), Math.round(y - SPH)); // top-left of sprite
  if(facing===-1){ ctx.translate(SPW,0); ctx.scale(-1,1); }
  ctx.drawImage(spr, 0, 0, SPW, SPH);
  ctx.restore();
}

function drawEntitySprite(e){
  let spr;
  const isWalk = (e.state==='run'||e.state==='walk');
  const tick = Math.floor(frame*0.12 + e.id) % 2;

  if(e.type==='civ'){
    const cv = CIV_VARIANTS[e.civVar||0];
    spr = (isWalk && tick===1) ? cv.walk : cv.idle;
  } else if(e.type==='swat'){
    spr = (isWalk && tick===1) ? SWAT_SPRITES.walk : SWAT_SPRITES.idle;
  } else if(e.type==='wb'){
    spr = e.flashTimer>0 ? WB_SPRITES.flash : ((isWalk&&tick===1)?WB_SPRITES.walk:WB_SPRITES.idle);
  }

  const alpha = (e.state==='stunned') ? (0.7 + Math.sin(frame*.25)*.3) : 1;
  stampSprite(spr, e.x, e.y, e.facing, alpha);

  // Stun stars
  if(e.state==='stunned'){
    ctx.font=`${SCALE*3}px serif`; ctx.textAlign='center';
    ctx.fillText('â˜…',e.x+Math.cos(frame*.15)*8, e.y-SPH-2);
    ctx.fillText('â˜…',e.x+Math.cos(frame*.15+2)*8, e.y-SPH-2);
  }

  // HP mini bar for enemy SWATs
  if(e.type==='swat'&&e.team==='enemy'){
    const bw=SPW; const bx=e.x-SPW/2; const by=e.y-SPH-7;
    ctx.fillStyle='#500'; ctx.fillRect(bx,by,bw,4);
    ctx.fillStyle='#0c0'; ctx.fillRect(bx,by,bw*(Math.max(0,3-(e.hits||0))/3),4);
  }
}

function drawHeroSprite(){
  let spr;
  const isWalk = hero.state==='walk'||hero.state==='run';
  const tick = Math.floor(frame*.12)%2;
  if(GAME_MODE==='whistleblower'){
    spr = hero.flashTimer>0 ? WB_SPRITES.flash : (isWalk&&tick===1 ? WB_SPRITES.walk : WB_SPRITES.idle);
  } else {
    spr = (hero.swingTimer>0) ? SWAT_SPRITES.swing : (isWalk&&tick===1 ? SWAT_SPRITES.walk : SWAT_SPRITES.idle);
  }
  const alpha = (hero.invincible>0&&frame%4<2) ? 0.35 : 1;
  stampSprite(spr, hero.x, hero.y, hero.facing, alpha);
}

function drawFlash(x,y,ang){
  ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
  const g=ctx.createLinearGradient(0,0,110,0);
  g.addColorStop(0,'rgba(255,255,255,0.88)');
  g.addColorStop(.5,'rgba(255,255,230,0.38)');
  g.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(0,-6); ctx.lineTo(110,-38); ctx.lineTo(110,38); ctx.lineTo(0,6); ctx.fill();
  ctx.restore();
}

function drawItems(){
  items.forEach(i=>{
    ctx.save(); ctx.translate(i.x,i.y);
    const p=Math.sin(frame*.09)*2.5;
    ctx.shadowBlur=5+p; ctx.shadowColor='#fff';
    if(i.type==='film'){
      ctx.fillStyle='#111'; ctx.fillRect(-7,-10,14,20);
      for(let k=-8;k<8;k+=3){ ctx.fillStyle='#444'; ctx.fillRect(-6,k,2,2); ctx.fillRect(4,k,2,2); }
      ctx.fillStyle='#3a9'; ctx.fillRect(-3,-6,6,12);
    } else if(i.type==='medkit'){
      ctx.fillStyle='#c0392b'; ctx.fillRect(-8,-8,16,16);
      ctx.fillStyle='#fff'; ctx.fillRect(-3,-7,6,14); ctx.fillRect(-7,-3,14,6);
    } else if(i.type==='boot'){
      ctx.fillStyle='#222'; ctx.beginPath(); ctx.moveTo(-5,-7); ctx.lineTo(5,-7); ctx.lineTo(5,3); ctx.lineTo(7,3); ctx.lineTo(7,7); ctx.lineTo(-5,7); ctx.fill();
      ctx.fillStyle='#555'; ctx.fillRect(-4,-6,8,3);
    }
    ctx.shadowBlur=0; ctx.restore();
  });
}

function drawCamp(){
  const W=canvas.width;
  // Background fill
  ctx.fillStyle='#2c3140'; ctx.fillRect(0,0,W,WIRE_Y);
  // Roof stripes
  for(let i=0;i<W;i+=20){ ctx.fillStyle=i%40?'#252a36':'#1e2230'; ctx.fillRect(i,0,20,WIRE_Y); }
  // Columns
  [[W/2-90,20],[W/2+70,20],[W/2+130,20]].forEach(([cx,cw])=>{ ctx.fillStyle='#181c24'; ctx.fillRect(cx,0,cw,WIRE_Y); ctx.fillStyle='rgba(255,255,255,0.05)'; ctx.fillRect(cx,0,2,WIRE_Y); });
  // Gate arch
  ctx.fillStyle='#0d0f14'; ctx.fillRect(W/2-42,WIRE_Y-72,84,72);
  ctx.fillStyle='#0a0c10'; ctx.fillRect(W/2-36,WIRE_Y-62,30,58); ctx.fillRect(W/2+6,WIRE_Y-62,30,58);
  ctx.fillStyle='rgba(200,30,30,0.12)'; ctx.fillRect(W/2-42,WIRE_Y-72,84,72);
  ctx.fillStyle='#181c24'; ctx.fillRect(W/2-3,WIRE_Y-72,6,72);
  // Sign
  ctx.fillStyle='#7a0000'; ctx.fillRect(W/2-52,WIRE_Y-93,104,18);
  ctx.fillStyle='#ffcc00'; ctx.font="bold 8px 'Press Start 2P',cursive"; ctx.textAlign='center';
  ctx.fillText('XINJIANG FACILITY',W/2,WIRE_Y-81);
  // Chimneys
  [[W/2-80],[W/2+80],[W/2+145]].forEach(([cx])=>{ ctx.fillStyle='#0d0f14'; ctx.fillRect(cx-4,0,8,18); ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(cx-3,0,2,18); });
  // Guard turrets
  [-1,1].forEach(s=>{ const tx=W/2+s*(W*.3); ctx.fillStyle='#181c24'; ctx.fillRect(tx-16,0,32,55); ctx.fillStyle='#1e2230'; ctx.fillRect(tx-20,50,40,14); ctx.fillStyle='rgba(255,120,0,.18)'; ctx.fillRect(tx-5,10,10,10); });
}

// Init
showStartScreen();
</script>
</body>
</html>
